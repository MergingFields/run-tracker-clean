<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Viewer - Event Driven (Fixed Layout)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; background: #222; color: #eee; font-family: sans-serif; overflow: hidden; }
        
        /* SIDEBAR: Fixed width on the left */
        #sidebar { 
            width: 250px; 
            background: #333; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            overflow-y: auto; 
            border-right: 1px solid #444;
        }

        /* MAIN AREA: Takes remaining space */
        #main-area { 
            flex: 1; 
            display: flex; 
            flex-direction: row; /* Side-by-Side Layout */
            height: 100%;
        }
        
        /* 50/50 Split for Map and Video */
        #map-container { flex: 1; height: 100%; position: relative; }
        #video-container { 
            flex: 1; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border-left: 2px solid #444;
        }
        
        /* Video fits inside container without scrolling */
        video { 
            max-width: 100%; 
            max-height: 100%; 
            width: auto; 
            height: auto; 
        }

        /* Controls */
        .control-group { background: #444; padding: 10px; border-radius: 4px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 11px; color: #aaa; letter-spacing: 1px; }
        button, input[type="file"] { width: 100%; margin-bottom: 5px; font-size: 12px; }
        
        /* Data Display */
        .data-row { display: flex; justify-content: space-between; font-family: monospace; font-size: 12px; margin-bottom: 2px; }
        .val { color: #4fceff; }

        /* Playlist */
        #playlist { margin-top: 5px; max-height: 200px; overflow-y: auto; }
        .playlist-item { 
            padding: 6px; 
            background: #555; 
            margin-bottom: 2px; 
            cursor: pointer; 
            font-size: 11px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        .playlist-item.active { background: #4fceff; color: #000; font-weight: bold; }
        .playlist-item:hover { background: #666; }

        /* Back Button */
        .nav-btn {
            display: block;
            background: #666;
            color: white;
            text-align: center;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .nav-btn:hover { background: #888; }
    </style>
</head>
<body>

    <div id="sidebar">
        <a href="/" class="nav-btn">← BACK TO HUB</a>

        <div class="control-group">
            <label>1. LOAD DATA (JSON)</label>
            <input type="file" id="jsonInput" accept=".json">
            <div id="file-meta" style="font-size:11px; color:#aaa;">No file loaded</div>
        </div>

        <div class="control-group">
            <label>2. PLAYLIST (Select Multiple)</label>
            <input type="file" id="videoInput" accept="video/*" multiple>
            <div id="playlist"></div>
        </div>

        <div class="control-group">
            <label>LIVE TELEMETRY</label>
            <div class="data-row"><span>Time:</span> <span id="disp-time" class="val">0.00</span></div>
            <div class="data-row"><span>Vel:</span> <span id="disp-vel" class="val">0.00</span></div>
            <div class="data-row"><span>Acc:</span> <span id="disp-acc" class="val">0.00</span></div>
            <div class="data-row"><span>Heading:</span> <span id="disp-head" class="val">0°</span></div>
        </div>
    </div>

    <div id="main-area">
        <div id="map-container"></div>
        <div id="video-container">
            <video id="mainVideo" controls playsinline></video>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- STATE ---
        const state = {
            data: null,
            videos: [],
            currentVideoIdx: 0,
            isPlaying: false
        };

        // --- ELEMENTS ---
        const els = {
            video: document.getElementById('mainVideo'),
            map: document.getElementById('map-container'),
            playlist: document.getElementById('playlist'),
            displays: {
                time: document.getElementById('disp-time'),
                vel: document.getElementById('disp-vel'),
                acc: document.getElementById('disp-acc'),
                head: document.getElementById('disp-head')
            }
        };

        // --- MAP SETUP ---
        const map = L.map('map-container').setView([55.75, 12.56], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
        
        const layers = {
            path: L.polyline([], { color: 'blue', weight: 4 }).addTo(map),
            marker: L.circleMarker([0,0], { color: 'red', radius: 8, fillOpacity: 1, stroke: true, weight: 2, color: 'white' }).addTo(map),
            mediaMarkers: L.layerGroup().addTo(map)
        };

        const channel = new BroadcastChannel('gps_video_sync');

        // --- LISTENERS ---
        
        // 1. Load JSON
        document.getElementById('jsonInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const json = JSON.parse(evt.target.result);
                    processData(json);
                    document.getElementById('file-meta').innerText = `Pts: ${json.track_points ? json.track_points.length : 0}`;
                } catch(err) { alert("JSON Error: " + err); }
            };
            reader.readAsText(file);
        });

        // 2. Load Videos
        document.getElementById('videoInput').addEventListener('change', (e) => {
            state.videos = Array.from(e.target.files);
            // Sort videos by name to ensure sequence (optional)
            state.videos.sort((a,b) => a.name.localeCompare(b.name));
            renderPlaylist();
            if(state.videos.length > 0) loadVideo(0);
        });

        // 3. Auto-Play Next Video
        els.video.addEventListener('ended', () => {
            if(state.currentVideoIdx < state.videos.length - 1) {
                console.log("Video ended. Auto-playing next...");
                loadVideo(state.currentVideoIdx + 1);
            }
        });

        // 4. Time Update
        els.video.addEventListener('timeupdate', () => {
            const t = els.video.currentTime;
            channel.postMessage({ time: t, source: 'video' });
            updateVisuals(t);
        });

        // --- FUNCTIONS ---

        function processData(json) {
            state.data = json;
            if(json.track_points && json.track_points.length > 0) {
                const latlngs = json.track_points.map(p => [p.lat, p.lng]);
                layers.path.setLatLngs(latlngs);
                map.fitBounds(layers.path.getBounds());
            }
        }

        function updateVisuals(time) {
            if(!state.data || !state.data.track_points) return;
            els.displays.time.innerText = time.toFixed(2);
            
            // Logic to handle playlist offsetting could go here. 
            // For now, we assume JSON time matches Video 1 time.
            // If videos are sequential segments of one run, you need "Global Time" logic.
            // But based on your current setup, we stick to simple file time.

            const pts = state.data.track_points;
            let currentPt = pts[0];

            for(let i=0; i<pts.length; i++) {
                if(pts[i].time <= time) currentPt = pts[i];
                else break; 
            }

            if(currentPt) {
                layers.marker.setLatLng([currentPt.lat, currentPt.lng]);
                els.displays.vel.innerText = (currentPt.vel || 0).toFixed(2);
                els.displays.acc.innerText = (currentPt.acc || 0).toFixed(2);
                els.displays.head.innerText = (currentPt.heading || 0).toFixed(0) + "°";
            }
        }

        function renderPlaylist() {
            els.playlist.innerHTML = '';
            state.videos.forEach((vid, idx) => {
                const div = document.createElement('div');
                div.className = 'playlist-item ' + (idx === state.currentVideoIdx ? 'active' : '');
                div.innerText = `${idx+1}. ${vid.name}`;
                div.onclick = () => loadVideo(idx);
                els.playlist.appendChild(div);
            });
        }

        function loadVideo(idx) {
            state.currentVideoIdx = idx;
            const file = state.videos[idx];
            els.video.src = URL.createObjectURL(file);
            renderPlaylist();
            els.video.play().catch(e => console.log("Autoplay blocked until interaction"));
        }
    </script>
</body>
</html>