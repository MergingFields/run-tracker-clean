<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Viewer - Game Loop Mode (Playlists Added)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* Dashboard Grid */
        #dashboard { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 60vh 40vh; height: 100vh; width: 100vw; }
        
        #map-panel { grid-column: 1; grid-row: 1; position: relative; border-right: 2px solid #333; }
        #video-panel { grid-column: 2; grid-row: 1; position: relative; background: #111; display: flex; justify-content: center; align-items: center; }
        #graph-panel { grid-column: 1 / span 2; grid-row: 2; background: #050505; border-top: 2px solid #333; padding: 10px; position: relative; }

        /* Video & Canvas Overlay */
        video { width: 100%; max-height: 100%; }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }

        /* Floating Controls */
        #controls { 
            position: absolute; 
            top: 10px; 
            left: 50px; /* Offset for map zoom controls */
            z-index: 1000; 
            background: rgba(0,0,0,0.85); 
            padding: 15px; 
            border: 1px solid #444; 
            border-radius: 4px;
            max-width: 250px;
        }
        
        input[type="file"] { display: block; margin-bottom: 8px; color: white; font-size: 11px; width: 100%; }
        
        button { 
            background: #0f0; color: #000; border: none; padding: 5px 10px; 
            font-weight: bold; cursor: pointer; margin-right: 5px; 
        }
        button:hover { background: #fff; }

        .nav-btn {
            display: inline-block;
            background: #333; color: #fff; 
            text-decoration: none; padding: 4px 8px; font-size: 11px; border: 1px solid #555;
            margin-bottom: 10px;
        }

        /* Playlist Styles (Mini) */
        #playlist { max-height: 100px; overflow-y: auto; margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; }
        .playlist-item { font-size: 10px; padding: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .playlist-item.active { color: #fff; font-weight: bold; background: #333; }
        
    </style>
</head>
<body>

    <div id="controls">
        <a href="/" class="nav-btn">‚Üê HUB</a><br>
        <strong>GAME LOOP MODE</strong><br>
        <div style="font-size:10px; color:#aaa; margin-bottom:10px;">Interpolated 60fps</div>
        
        <input type="file" id="jsonInput" accept=".json">
        <input type="file" id="videoInput" accept="video/*" multiple>
        
        <div style="margin-top:5px;">
            <button onclick="vid.play()">PLAY</button>
            <button onclick="vid.pause()">PAUSE</button>
        </div>

        <div id="playlist"></div>

        <div id="fps-counter" style="color: #fff; margin-top:5px; font-size:10px;">FPS: 0</div>
    </div>

    <div id="dashboard">
        <div id="map-panel"></div>
        <div id="video-panel">
            <video id="mainVideo" playsinline></video>
            <canvas id="hudCanvas"></canvas>
        </div>
        <div id="graph-panel">
            <canvas id="graphCanvas"></canvas>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- SETUP ---
        const map = L.map('map-panel').setView([55.75, 12.56], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
        
        const layers = {
            marker: L.circleMarker([0,0], { color: '#0f0', radius: 8, fillOpacity: 0.8 }).addTo(map),
            path: L.polyline([], { color: '#054400', weight: 2 }).addTo(map)
        };

        const vid = document.getElementById('mainVideo');
        const hudCanvas = document.getElementById('hudCanvas');
        const hudCtx = hudCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');
        const playlistEl = document.getElementById('playlist');

        let trackData = [];
        let isReady = false;
        
        // Playlist State
        let videoFiles = [];
        let currentVidIdx = 0;

        // --- RESIZE ---
        function resize() {
            if(!vid) return;
            hudCanvas.width = vid.clientWidth || 600;
            hudCanvas.height = vid.clientHeight || 400;
            // Graph
            const graphPanel = document.getElementById('graph-panel');
            graphCanvas.width = graphPanel.clientWidth;
            graphCanvas.height = graphPanel.clientHeight;
        }
        window.addEventListener('resize', resize);
        setTimeout(resize, 1000);

        // --- LOAD DATA ---
        document.getElementById('jsonInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const json = JSON.parse(evt.target.result);
                trackData = json.track_points || [];
                
                // Draw path
                const latlngs = trackData.map(p => [p.lat, p.lng]);
                layers.path.setLatLngs(latlngs);
                map.fitBounds(layers.path.getBounds());
                
                isReady = true;
                drawStaticGraph();
            };
            reader.readAsText(e.target.files[0]);
        });

        // --- LOAD VIDEOS (PLAYLIST LOGIC) ---
        document.getElementById('videoInput').addEventListener('change', (e) => {
            videoFiles = Array.from(e.target.files);
            // Sort alphabetically to maintain order
            videoFiles.sort((a,b) => a.name.localeCompare(b.name));
            renderPlaylist();
            if(videoFiles.length > 0) loadVideo(0);
        });

        function renderPlaylist() {
            playlistEl.innerHTML = '';
            videoFiles.forEach((file, idx) => {
                const div = document.createElement('div');
                div.className = 'playlist-item ' + (idx === currentVidIdx ? 'active' : '');
                div.innerText = `${idx+1}. ${file.name}`;
                div.onclick = () => loadVideo(idx);
                playlistEl.appendChild(div);
            });
        }

        function loadVideo(idx) {
            currentVidIdx = idx;
            vid.src = URL.createObjectURL(videoFiles[idx]);
            renderPlaylist();
            vid.play().then(() => resize());
        }

        // --- AUTO-PLAY NEXT ---
        vid.addEventListener('ended', () => {
            if(currentVidIdx < videoFiles.length - 1) {
                loadVideo(currentVidIdx + 1);
            }
        });

        // --- THE GAME LOOP ---
        function loop() {
            if(isReady && !vid.paused) {
                const t = vid.currentTime;
                const state = getInterpolatedState(t);
                
                if(state) {
                    layers.marker.setLatLng([state.lat, state.lng]);
                    drawHUD(state);
                    drawGraphCursor(t);
                }
            }
            requestAnimationFrame(loop);
        }
        requestAnimationFrame(loop);

        // --- INTERPOLATION ---
        function getInterpolatedState(time) {
            for(let i=0; i<trackData.length - 1; i++) {
                const p1 = trackData[i];
                const p2 = trackData[i+1];
                if(time >= p1.time && time < p2.time) {
                    const pct = (time - p1.time) / (p2.time - p1.time);
                    return {
                        lat: p1.lat + (p2.lat - p1.lat) * pct,
                        lng: p1.lng + (p2.lng - p1.lng) * pct,
                        vel: p1.vel + (p2.vel - p1.vel) * pct,
                        acc: p1.acc + (p2.acc - p1.acc) * pct
                    };
                }
            }
            return trackData[0];
        }

        // --- DRAWING ---
        function drawHUD(state) {
            hudCtx.clearRect(0, 0, hudCanvas.width, hudCanvas.height);
            // Bar
            const barHeight = Math.min(state.vel * 10, 100);
            hudCtx.fillStyle = "rgba(0, 255, 0, 0.5)";
            hudCtx.fillRect(20, hudCanvas.height - 20 - barHeight, 20, barHeight);
            // Text
            hudCtx.fillStyle = "#fff";
            hudCtx.font = "12px monospace";
            hudCtx.fillText(`V: ${state.vel.toFixed(1)}`, 20, hudCanvas.height - 125);
        }

        function drawStaticGraph() {
            if(!trackData.length) return;
            const w = graphCanvas.width;
            const h = graphCanvas.height;
            graphCtx.clearRect(0,0,w,h);
            graphCtx.strokeStyle = "#004400";
            graphCtx.lineWidth = 1;
            graphCtx.beginPath();
            
            const totalTime = trackData[trackData.length-1].time;
            for(let i=0; i<trackData.length; i++) {
                const pt = trackData[i];
                const x = (pt.time / totalTime) * w;
                const y = h - (pt.vel * 5); 
                if(i===0) graphCtx.moveTo(x,y);
                else graphCtx.lineTo(x,y);
            }
            graphCtx.stroke();
        }

        function drawGraphCursor(time) {
            // A simple "redraw everything" approach for the cursor
            drawStaticGraph(); // Redraw background
            const w = graphCanvas.width;
            const totalTime = trackData[trackData.length-1].time;
            const x = (time / totalTime) * w;
            
            graphCtx.strokeStyle = "#fff";
            graphCtx.beginPath();
            graphCtx.moveTo(x, 0);
            graphCtx.lineTo(x, graphCanvas.height);
            graphCtx.stroke();
        }
    </script>
</body>
</html>