<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager (Universal)</title>
    <style>
        body { background: #111; color: #eee; font-family: 'Segoe UI', system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
        
        h1 { border-bottom: 1px solid #333; padding-bottom: 15px; display: flex; align-items: center; justify-content: space-between; color: #4fceff; }
        
        /* CARD DESIGN */
        .session-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .date { font-size: 18px; font-weight: bold; color: #fff; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; padding: 10px; background: #222; border-radius: 6px; }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; color: #aaa; text-transform: uppercase; }
        .stat-val { font-size: 16px; font-weight: bold; color: #4fceff; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-json { background: #4fceff; color: #000; }
        .btn-video { background: #ff4444; color: #fff; }
        .btn-del { background: transparent; border: 1px solid #444; color: #888; margin-left: auto; }
        .btn-del:hover { border-color: red; color: red; }
        .btn-home { background: #333; color: white; text-decoration: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; }

        #empty-msg { text-align: center; color: #555; margin-top: 50px; display: none; }
    </style>
</head>
<body>

    <a href="recorder-hybrid.html" class="btn-home">← New Recording</a>

    <h1>
        Your Runs
        <div style="font-size:12px; color:#666;" id="db-ver"></div>
    </h1>

    <div id="session-list"></div>
    <div id="empty-msg">No recordings found.</div>

    <script>
        const DB_NAME = "RunTrackerDB";

        // UNIVERSAL LOADER: Does not specify version, so it opens whatever exists!
        function loadSessions() {
            const req = indexedDB.open(DB_NAME); // <--- MAGIC FIX

            req.onsuccess = e => {
                const db = e.target.result;
                document.getElementById('db-ver').innerText = `DB v${db.version}`;
                
                if(!db.objectStoreNames.contains("sessions")) {
                    document.getElementById("empty-msg").style.display = "block";
                    return;
                }

                const tx = db.transaction("sessions", "readonly");
                const store = tx.objectStore("sessions");
                const request = store.getAll();

                request.onsuccess = () => {
                    const sessions = request.result;
                    const list = document.getElementById("session-list");
                    list.innerHTML = "";
                    
                    if (sessions.length === 0) {
                        document.getElementById("empty-msg").style.display = "block";
                        return;
                    }

                    // Sort: Newest First
                    sessions.sort((a, b) => b.id - a.id);

                    sessions.forEach(s => {
                        const dateObj = new Date(s.id);
                        
                        // Calculated Stats
                        const dist = (calcDistance(s.track_points) / 1000).toFixed(2);
                        const dur = formatDuration(s.duration);
                        const pts = s.track_points.length;

                        const div = document.createElement("div");
                        div.className = "session-card";
                        div.innerHTML = `
                            <div class="card-header">
                                <div class="date">${dateObj.toLocaleString()}</div>
                                <button class="btn-del" onclick="deleteSession(${s.id})">✕ Delete</button>
                            </div>
                            
                            <div class="stats-row">
                                <div class="stat"><span class="stat-label">Duration</span><span class="stat-val">${dur}</span></div>
                                <div class="stat"><span class="stat-label">Distance</span><span class="stat-val">${dist} km</span></div>
                                <div class="stat"><span class="stat-label">Points</span><span class="stat-val">${pts}</span></div>
                            </div>

                            <div class="btn-group">
                                <button class="btn-json" onclick="downloadJSON(${s.id})">⬇ JSON</button>
                                ${renderVideoButtons(s.videoData)}
                            </div>
                        `;
                        list.appendChild(div);
                    });
                };
            };
            
            req.onerror = () => alert("Database Error. Try restarting browser.");
        }

        function renderVideoButtons(videos) {
            if (!videos || videos.length === 0) return `<span style="color:#555; padding:8px;">No Video</span>`;
            return videos.map((v, i) => 
                `<button class="btn-video" onclick="downloadVideo('${v.filename}')">▶ Video ${i+1}</button>`
            ).join('');
        }

        function downloadJSON(id) {
            const req = indexedDB.open(DB_NAME);
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction("sessions", "readonly").objectStore("sessions").get(id).onsuccess = ev => {
                    const data = ev.target.result;
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `Run_${data.id}.json`; a.click();
                };
            };
        }

        function downloadVideo(filename) {
            const req = indexedDB.open(DB_NAME);
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction("videos", "readonly").objectStore("videos").get(filename).onsuccess = ev => {
                    const result = ev.target.result;
                    if (!result) return alert("Video file not found in DB!");
                    const url = URL.createObjectURL(result);
                    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
                };
            };
        }

        function deleteSession(id) {
            if(!confirm("Delete this run permanently?")) return;
            const req = indexedDB.open(DB_NAME);
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction(["sessions", "videos"], "readwrite");
                tx.objectStore("sessions").get(id).onsuccess = ev => {
                    const data = ev.target.result;
                    if(data && data.videoData) {
                        data.videoData.forEach(v => { try{ tx.objectStore("videos").delete(v.filename); }catch(e){} });
                    }
                    tx.objectStore("sessions").delete(id);
                };
                tx.oncomplete = () => loadSessions();
            };
        }

        // Stats Utils
        function calcDistance(pts) {
            if (!pts || pts.length < 2) return 0;
            let d = 0;
            for (let i = 1; i < pts.length; i++) {
                const R = 6371e3;
                const p1 = pts[i-1], p2 = pts[i];
                const φ1 = p1.lat*Math.PI/180, φ2 = p2.lat*Math.PI/180;
                const Δφ = (p2.lat-p1.lat)*Math.PI/180, Δλ = (p2.lng-p1.lng)*Math.PI/180;
                const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) + Math.cos(φ1)*Math.cos(φ2) * Math.sin(Δλ/2)*Math.sin(Δλ/2);
                d += R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
            return d;
        }
        function formatDuration(sec) {
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}m ${s}s`;
        }

        loadSessions();
    </script>
</body>
</html>