<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager (Restored)</title>
    <style>
        body { background: #111; color: #eee; font-family: system-ui; padding: 20px; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .session-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stats { display: flex; gap: 15px; font-size: 12px; font-family: monospace; color: #4fceff; margin-bottom: 15px; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; text-align: left; }
        .btn-json { background: #4fceff; color: #000; text-align: center; }
        .btn-vid-row { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
        .btn-vid { background: #ff4444; color: white; flex-shrink: 0; padding: 8px 15px; font-size: 12px; }
        .btn-del { background: transparent; border: 1px solid #555; color: #888; margin-top: 10px; width: 100%; text-align: center; }
        .home-link { display: inline-block; margin-bottom: 20px; color: #888; text-decoration: none; }
    </style>
</head>
<body>

    <a href="recorder-hybrid.html" class="home-link">‚Üê New Recording</a>
    <h1>Recorded Sessions</h1>
    <div id="session-list"></div>
    <div id="debug-msg" style="color:#666; font-size:10px;"></div>

    <script>
        const DB_NAME = "RunTrackerDB";

        function loadSessions() {
            // OPEN WITHOUT VERSION NUMBER -> Opens whatever exists (Universal Fix)
            const req = indexedDB.open(DB_NAME);
            
            req.onsuccess = e => {
                const db = e.target.result;
                document.getElementById('debug-msg').innerText = `Connected to DB v${db.version}`;

                if (!db.objectStoreNames.contains("sessions")) {
                    document.getElementById("session-list").innerHTML = "No sessions found (Empty DB).";
                    return;
                }

                const tx = db.transaction("sessions", "readonly");
                const store = tx.objectStore("sessions");
                const request = store.getAll();

                request.onsuccess = () => {
                    const sessions = request.result;
                    const list = document.getElementById("session-list");
                    list.innerHTML = "";
                    
                    if (sessions.length === 0) list.innerHTML = "<div style='color:#555'>No recordings yet.</div>";

                    sessions.sort((a, b) => b.id - a.id).forEach(s => {
                        const date = new Date(s.id).toLocaleString();
                        const dist = calcDistance(s.track_points).toFixed(2);
                        const dur = (s.duration / 60).toFixed(1);
                        
                        const div = document.createElement("div");
                        div.className = "session-card";
                        
                        let vidButtons = "";
                        if(s.videoData && s.videoData.length > 0) {
                            vidButtons = `<div class="btn-vid-row">` + 
                                s.videoData.map((v, i) => `<button class="btn-vid" onclick="downloadVideo('${v.filename}')">üé• Video ${i+1}</button>`).join('') +
                                `</div>`;
                        } else {
                            vidButtons = `<div style="color:#555; font-size:12px;">No Video</div>`;
                        }

                        div.innerHTML = `
                            <div style="font-size:16px; font-weight:bold; margin-bottom:5px; color:white;">${date}</div>
                            <div class="stats">
                                <span>‚è± ${dur} min</span>
                                <span>üìè ${dist} m</span>
                                <span>üì∏ ${s.photos.length}</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn-json" onclick="downloadJSON(${s.id})">‚¨á Download JSON Data</button>
                                ${vidButtons}
                                <button class="btn-del" onclick="deleteRun(${s.id})">Delete Session</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                };
            };
            
            req.onerror = () => alert("DB Error.");
        }

        function calcDistance(pts) {
            if(!pts || pts.length < 2) return 0;
            let d = 0;
            for(let i=1; i<pts.length; i++) {
                const R = 6371e3; 
                const œÜ1 = pts[i-1].lat * Math.PI/180, œÜ2 = pts[i].lat * Math.PI/180;
                const ŒîœÜ = (pts[i].lat-pts[i-1].lat) * Math.PI/180;
                const ŒîŒª = (pts[i].lng-pts[i-1].lng) * Math.PI/180;
                const a = Math.sin(ŒîœÜ/2)*Math.sin(ŒîœÜ/2) + Math.cos(œÜ1)*Math.cos(œÜ2) * Math.sin(ŒîŒª/2)*Math.sin(ŒîŒª/2);
                d += R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
            return d;
        }

        function downloadJSON(id) {
            const req = indexedDB.open(DB_NAME);
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction("sessions", "readonly").objectStore("sessions").get(id).onsuccess = ev => {
                    const data = ev.target.result;
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const safeDate = new Date(data.id).toISOString().replace(/[:.]/g, '-');
                    a.href = url; a.download = `Run_${safeDate}.json`; a.click();
                };
            };
        }

        function downloadVideo(filename) {
            const req = indexedDB.open(DB_NAME);
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction("videos", "readonly").objectStore("videos").get(filename).onsuccess = ev => {
                    const result = ev.target.result;
                    if (!result) return alert("Video file missing from DB!");
                    const url = URL.createObjectURL(result); 
                    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
                };
            };
        }

        function deleteRun(id) {
            if(!confirm("Delete?")) return;
            const req = indexedDB.open(DB_NAME);
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction(["sessions", "videos"], "readwrite");
                tx.objectStore("sessions").get(id).onsuccess = ev => {
                    const run = ev.target.result;
                    if(run && run.videoData) run.videoData.forEach(v => tx.objectStore("videos").delete(v.filename));
                    tx.objectStore("sessions").delete(id);
                };
                tx.oncomplete = () => window.location.reload();
            };
        }

        loadSessions();
    </script>
</body>
</html>