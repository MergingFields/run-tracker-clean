<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager V11</title>
    <style>
        body { background: #111; color: #eee; font-family: system-ui; padding: 20px; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .version-tag { font-size: 12px; background: #333; padding: 5px 10px; border-radius: 10px; color: #aaa; }
        .session-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stats { display: flex; gap: 15px; font-size: 12px; font-family: monospace; color: #4fceff; margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-json { background: #4fceff; color: #000; }
        .btn-vid { background: #ff4444; color: #fff; }
        .btn-del { background: #333; color: #aaa; max-width: 50px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #aaa; text-decoration: none; }
        .btn-reset { background: #000; border: 1px solid red; color: red; padding: 15px; width: 100%; margin-top:50px; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Menu</a>
    <h1>Saved Sessions <span class="version-tag">Manager V11 (v105)</span></h1>
    <div id="list">Loading...</div>
    <div style="text-align:center"><button class="btn-reset" onclick="nukeDB()">‚ö†Ô∏è RESET DATABASE</button></div>

    <script>
        const list = document.getElementById('list');
        const request = indexedDB.open("RunTrackerDB", 105);
        
        request.onsuccess = function(e) {
            const db = e.target.result;
            if(!db.objectStoreNames.contains("sessions")) { list.innerHTML = "No sessions found."; return; }
            loadSessions(db);
        };
        request.onerror = e => list.innerHTML = "DB Error: " + e.target.error;

        function loadSessions(db) {
            const tx = db.transaction("sessions", "readonly");
            const req = tx.objectStore("sessions").getAll();

            req.onsuccess = function() {
                const runs = req.result;
                if(runs.length === 0) { list.innerHTML = "No runs saved."; return; }
                runs.sort((a,b) => new Date(b.date) - new Date(a.date));
                list.innerHTML = '';
                
                runs.forEach(run => {
                    const date = new Date(run.date).toLocaleString();
                    const vids = run.videoData || [];
                    const vidLabel = vids.length > 0 ? `${vids.length} Clips` : "None";
                    
                    const div = document.createElement('div');
                    div.className = 'session-card';
                    div.innerHTML = `
                        <div style="color:#aaa; font-size:14px; margin-bottom:10px;">${date}</div>
                        <div class="stats">
                            <span>‚è± ${Math.floor(run.duration/60)}:${(run.duration%60).toString().padStart(2,'0')}</span>
                            <span>üì∏ ${run.photos.length}</span>
                            <span>üíæ ${vidLabel}</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn-json" onclick="downloadJSON(${run.id})">JSON (Linked)</button>
                            ${vids.length > 0 ? `<button class="btn-vid" onclick="downloadVideos(${run.id})">VIDEOS</button>` : ''}
                            <button class="btn-del" onclick="deleteRun(${run.id})">üóë</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            };
        }

        function downloadJSON(id) {
            useDB(store => {
                store.get(id).onsuccess = e => {
                    const rawData = e.target.result;
                    const cleanVideos = (rawData.videoData || []).map(v => ({ filename: v.filename, startTime: v.startTime, endTime: v.endTime }));
                    const exportData = { ...rawData, videoData: cleanVideos };
                    delete exportData.videoBlob; delete exportData.videos;

                    const url = URL.createObjectURL(new Blob([JSON.stringify(exportData,null,2)], {type:'application/json'}));
                    const a = document.createElement('a'); a.href=url; 
                    const safeDate = rawData.date.replace(/:/g, '-').split('.')[0];
                    a.download = `Run_${safeDate}.json`; a.click();
                };
            });
        }

        function downloadVideos(id) {
            useDB(store => {
                store.get(id).onsuccess = e => {
                    const vids = e.target.result.videoData || [];
                    if(vids.length === 0) return alert("No videos.");
                    alert(`Downloading ${vids.length} videos...`);
                    vids.forEach((v, i) => {
                        setTimeout(() => {
                            const url = URL.createObjectURL(v.blob);
                            const a = document.createElement('a'); a.href = url; a.download = v.filename; a.click();
                        }, i * 1000);
                    });
                };
            });
        }

        function deleteRun(id) {
            if(!confirm("Delete?")) return;
            const req = indexedDB.open("RunTrackerDB", 105);
            req.onsuccess = e => {
                const tx = e.target.result.transaction("sessions", "readwrite");
                tx.objectStore("sessions").delete(id);
                tx.oncomplete = () => window.location.reload();
            };
        }

        function nukeDB() {
            if(!confirm("DELETE ALL?")) return;
            indexedDB.deleteDatabase("RunTrackerDB").onsuccess = () => window.location.reload();
        }

        function useDB(cb) {
            const req = indexedDB.open("RunTrackerDB", 105);
            req.onsuccess = e => cb(e.target.result.transaction("sessions", "readonly").objectStore("sessions"));
        }
    </script>
</body>
</html>