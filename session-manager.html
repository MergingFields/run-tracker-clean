<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager V14</title>
    <style>
        body { background: #111; color: #eee; font-family: system-ui; padding: 20px; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; }
        .session-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stats { display: flex; gap: 15px; font-size: 12px; font-family: monospace; color: #4fceff; margin-bottom: 15px; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; text-align: left; }
        .btn-json { background: #4fceff; color: #000; text-align: center; }
        .btn-vid-row { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
        .btn-vid { background: #ff4444; color: #fff; flex: 1; min-width: 120px; text-align: center; font-size: 11px; white-space: nowrap; }
        .btn-del { background: #333; color: #aaa; margin-top: 10px; width: 100%; text-align: center; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #aaa; text-decoration: none; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Menu</a>
    <h1>Saved Sessions <span style="font-size:12px; color:#00e676;">V14</span></h1>
    <div id="list">Loading...</div>

    <script>
        const DB_VERSION = 106;
        const list = document.getElementById('list');
        const request = indexedDB.open("RunTrackerDB", DB_VERSION);
        
        request.onsuccess = function(e) {
            const db = e.target.result;
            loadSessions(db);
        };
        request.onerror = e => list.innerHTML = "DB Error. Refresh.";

        function loadSessions(db) {
            if(!db.objectStoreNames.contains("sessions")) { list.innerHTML = "No sessions found."; return; }
            const tx = db.transaction("sessions", "readonly");
            const req = tx.objectStore("sessions").getAll();

            req.onsuccess = function() {
                const runs = req.result;
                if(runs.length === 0) { list.innerHTML = "No runs saved."; return; }
                runs.sort((a,b) => new Date(b.date) - new Date(a.date));
                list.innerHTML = '';
                
                runs.forEach(run => {
                    const date = new Date(run.date).toLocaleString();
                    const vids = run.videoData || [];
                    
                    // Generate buttons for EACH video using the SMART NAME
                    let vidButtons = '';
                    if(vids.length > 0) {
                        vidButtons = `<div class="btn-vid-row">`;
                        vids.forEach((v) => {
                            // Display shorter name on button, but download full name
                            const shortName = v.filename.split('_Clip_')[1] || v.filename; 
                            vidButtons += `<button class="btn-vid" onclick="downloadVideo('${v.filename}')">üé• ${shortName}</button>`;
                        });
                        vidButtons += `</div>`;
                    } else {
                        vidButtons = `<div style="color:#666; font-size:12px;">No Videos</div>`;
                    }

                    const div = document.createElement('div');
                    div.className = 'session-card';
                    div.innerHTML = `
                        <div style="color:#aaa; font-size:14px; margin-bottom:10px;">${date}</div>
                        <div class="stats">
                            <span>‚è± ${Math.floor(run.duration/60)}:${Math.floor(run.duration%60)}</span>
                            <span>üì∏ ${run.photos.length}</span>
                            <span>üíæ ${vids.length} Clips</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn-json" onclick="downloadChunkedJSON(${run.id})">üìÑ Download JSON</button>
                            ${vidButtons}
                            <button class="btn-del" onclick="deleteRun(${run.id})">üóë Delete Session</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            };
        }

        // --- DOWNLOADERS ---
        function chunkString(str, length) {
            return str.match(new RegExp('.{1,' + length + '}', 'g'));
        }

        function downloadChunkedJSON(id) {
            const req = indexedDB.open("RunTrackerDB", DB_VERSION);
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction("sessions", "readonly").objectStore("sessions").get(id).onsuccess = ev => {
                    const rawData = ev.target.result;
                    
                    // Process Photos (Chunking)
                    const processedPhotos = (rawData.photos || []).map(p => {
                        const newPhoto = { ...p };
                        if (newPhoto.src && newPhoto.src.length > 50000) {
                            newPhoto.src_chunks = chunkString(newPhoto.src, 50000);
                            delete newPhoto.src;
                        }
                        return newPhoto;
                    });

                    const exportData = { 
                        ...rawData, 
                        photos: processedPhotos, 
                        // Video data already has filenames in it
                    };

                    const url = URL.createObjectURL(new Blob([JSON.stringify(exportData,null,2)], {type:'application/json'}));
                    const a = document.createElement('a'); 
                    a.href=url; 
                    // Name JSON: Run_2026-01-14_10-30.json
                    const safeDate = rawData.date.replace(/:/g, '-').split('.')[0].replace('T', '_');
                    a.download = `Run_${safeDate}.json`; 
                    a.click();
                };
            };
        }

        function downloadVideo(filename) {
            const req = indexedDB.open("RunTrackerDB", DB_VERSION);
            req.onsuccess = e => {
                const db = e.target.result;
                // Retrieve video Blob by FILENAME (Key)
                const tx = db.transaction("videos", "readonly");
                const store = tx.objectStore("videos");
                
                store.get(filename).onsuccess = ev => {
                    const result = ev.target.result;
                    if (!result) return alert("Video file missing from DB!");
                    
                    const url = URL.createObjectURL(result.blob);
                    const a = document.createElement('a'); 
                    a.href = url; 
                    a.download = filename; // Uses the unique Smart Name
                    a.click();
                };
            };
        }

        function deleteRun(id) {
            if(!confirm("Delete?")) return;
            const req = indexedDB.open("RunTrackerDB", DB_VERSION);
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction(["sessions", "videos"], "readwrite");
                
                // 1. Get the session to find which videos to delete
                tx.objectStore("sessions").get(id).onsuccess = ev => {
                    const run = ev.target.result;
                    if(run.videoData) {
                        run.videoData.forEach(v => {
                            tx.objectStore("videos").delete(v.filename);
                        });
                    }
                    // 2. Delete the session itself
                    tx.objectStore("sessions").delete(id);
                };
                
                tx.oncomplete = () => window.location.reload();
            };
        }
    </script>
</body>
</html>