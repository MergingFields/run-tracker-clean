<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager V12</title>
    <style>
        body { background: #111; color: #eee; font-family: system-ui; padding: 20px; }
        h1 { border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .version-tag { font-size: 12px; background: #333; padding: 5px 10px; border-radius: 10px; color: #aaa; }
        .session-card { background: #222; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stats { display: flex; gap: 15px; font-size: 12px; font-family: monospace; color: #4fceff; margin-bottom: 15px; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; text-align: left; }
        .btn-json { background: #4fceff; color: #000; text-align: center; }
        .btn-vid-row { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; }
        .btn-vid { background: #ff4444; color: #fff; flex: 1; min-width: 80px; text-align: center; font-size: 12px; }
        .btn-del { background: #333; color: #aaa; margin-top: 10px; width: 100%; text-align: center; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #aaa; text-decoration: none; }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê Back to Menu</a>
    <h1>Saved Sessions <span class="version-tag">V12 (Individual)</span></h1>
    <div id="list">Loading...</div>

    <script>
        const list = document.getElementById('list');
        const request = indexedDB.open("RunTrackerDB", 105);
        
        request.onsuccess = function(e) {
            const db = e.target.result;
            if(!db.objectStoreNames.contains("sessions")) { list.innerHTML = "No sessions found."; return; }
            loadSessions(db);
        };
        request.onerror = e => list.innerHTML = "DB Error: " + e.target.error;

        function loadSessions(db) {
            const tx = db.transaction("sessions", "readonly");
            const req = tx.objectStore("sessions").getAll();

            req.onsuccess = function() {
                const runs = req.result;
                if(runs.length === 0) { list.innerHTML = "No runs saved."; return; }
                runs.sort((a,b) => new Date(b.date) - new Date(a.date));
                list.innerHTML = '';
                
                runs.forEach(run => {
                    const date = new Date(run.date).toLocaleString();
                    const vids = run.videoData || [];
                    
                    // Generate buttons for EACH video
                    let vidButtons = '';
                    if(vids.length > 0) {
                        vidButtons = `<div class="btn-vid-row">`;
                        vids.forEach((v, i) => {
                            vidButtons += `<button class="btn-vid" onclick="downloadSingleVideo(${run.id}, ${i})">üé• Clip ${i+1}</button>`;
                        });
                        vidButtons += `</div>`;
                    } else {
                        vidButtons = `<div style="color:#666; font-size:12px;">No Videos</div>`;
                    }

                    const div = document.createElement('div');
                    div.className = 'session-card';
                    div.innerHTML = `
                        <div style="color:#aaa; font-size:14px; margin-bottom:10px;">${date}</div>
                        <div class="stats">
                            <span>‚è± ${Math.floor(run.duration/60)}:${(run.duration%60).toString().padStart(2,'0')}</span>
                            <span>üì∏ ${run.photos.length}</span>
                            <span>üíæ ${vids.length} Clips</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn-json" onclick="downloadJSON(${run.id})">üìÑ Download JSON (Data)</button>
                            ${vidButtons}
                            <button class="btn-del" onclick="deleteRun(${run.id})">üóë Delete Session</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            };
        }

        function downloadJSON(id) {
            useDB(store => {
                store.get(id).onsuccess = e => {
                    const rawData = e.target.result;
                    const cleanVideos = (rawData.videoData || []).map(v => ({ filename: v.filename, startTime: v.startTime, endTime: v.endTime }));
                    const exportData = { ...rawData, videoData: cleanVideos };
                    const url = URL.createObjectURL(new Blob([JSON.stringify(exportData,null,2)], {type:'application/json'}));
                    const a = document.createElement('a'); a.href=url; 
                    const safeDate = rawData.date.replace(/:/g, '-').split('.')[0];
                    a.download = `Run_${safeDate}.json`; a.click();
                };
            });
        }

        function downloadSingleVideo(id, vidIndex) {
            useDB(store => {
                store.get(id).onsuccess = e => {
                    const vids = e.target.result.videoData || [];
                    if(!vids[vidIndex]) return alert("Video not found.");
                    
                    const v = vids[vidIndex];
                    const url = URL.createObjectURL(v.blob);
                    const a = document.createElement('a'); 
                    a.href = url; 
                    a.download = v.filename; 
                    a.click();
                };
            });
        }

        function deleteRun(id) {
            if(!confirm("Delete?")) return;
            const req = indexedDB.open("RunTrackerDB", 105);
            req.onsuccess = e => {
                const tx = e.target.result.transaction("sessions", "readwrite");
                tx.objectStore("sessions").delete(id);
                tx.oncomplete = () => window.location.reload();
            };
        }

        function useDB(cb) {
            const req = indexedDB.open("RunTrackerDB", 105);
            req.onsuccess = e => cb(e.target.result.transaction("sessions", "readonly").objectStore("sessions"));
        }
    </script>
</body>
</html>