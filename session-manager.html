<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Manager V30</title>
    <style>
        body { background: #111; color: #eee; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        
        /* HEADER */
        h1 { border-bottom: 1px solid #333; padding-bottom: 15px; display: flex; align-items: center; justify-content: space-between; font-size: 24px; color: #4fceff; }
        
        /* CARDS */
        .session-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .session-card:hover { transform: translateY(-2px); border-color: #555; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .date { font-size: 18px; font-weight: bold; color: #fff; }
        .time { font-size: 14px; color: #888; }
        
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; padding: 10px; background: #222; border-radius: 6px; }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; color: #aaa; text-transform: uppercase; }
        .stat-val { font-size: 16px; font-weight: bold; color: #4fceff; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        
        button { padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: background 0.1s; }
        
        .btn-json { background: #4fceff; color: #000; }
        .btn-json:hover { background: #29b6f6; }
        
        .btn-video { background: #ff4444; color: #fff; }
        .btn-video:hover { background: #d32f2f; }
        
        .btn-del { background: transparent; border: 1px solid #444; color: #888; margin-left: auto; }
        .btn-del:hover { border-color: #ff4444; color: #ff4444; }

        .btn-home { background: #333; color: white; text-decoration: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; font-size: 14px; display: inline-block; }
        .btn-home:hover { background: #444; }

        #empty-msg { text-align: center; color: #555; margin-top: 50px; display: none; }
        .video-tag { font-size: 10px; background: #333; padding: 2px 6px; border-radius: 3px; color: #aaa; margin-left: 5px; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-home">← Home</a>

    <h1>
        Saved Runs
        <button onclick="wipeDatabase()" style="background:#222; color:#555; font-size:10px;">⚠️ Reset DB</button>
    </h1>

    <div id="session-list">
        </div>
    <div id="empty-msg">No recordings found.<br>Go for a run!</div>

    <script>
        // *** MUST MATCH RECORDER VERSION (V5) ***
        const DB_NAME = "RunTrackerDB";
        const DB_VERSION = 5;

        function loadSessions() {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            
            req.onupgradeneeded = e => {
                // If Manager is opened before Recorder, create the structure
                const db = e.target.result;
                if (!db.objectStoreNames.contains("sessions")) db.createObjectStore("sessions", { keyPath: "id" });
                if (!db.objectStoreNames.contains("videos")) db.createObjectStore("videos");
            };

            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction("sessions", "readonly");
                const store = tx.objectStore("sessions");
                const list = document.getElementById("session-list");
                const request = store.getAll();

                request.onsuccess = () => {
                    const sessions = request.result;
                    list.innerHTML = "";
                    
                    if (sessions.length === 0) {
                        document.getElementById("empty-msg").style.display = "block";
                        return;
                    }

                    // Sort new to old
                    sessions.sort((a, b) => b.id - a.id);

                    sessions.forEach(s => {
                        const dateObj = new Date(s.id);
                        const dateStr = dateObj.toLocaleDateString();
                        const timeStr = dateObj.toLocaleTimeString();
                        
                        // Calc stats
                        const dist = (calcDistance(s.track_points) / 1000).toFixed(2);
                        const dur = formatDuration(s.duration);
                        const pts = s.track_points.length;
                        const vids = s.videoData ? s.videoData.length : 0;

                        const div = document.createElement("div");
                        div.className = "session-card";
                        div.innerHTML = `
                            <div class="card-header">
                                <div>
                                    <div class="date">${dateStr}</div>
                                    <div class="time">${timeStr}</div>
                                </div>
                                <button class="btn-del" onclick="deleteSession(${s.id})">✕ Delete</button>
                            </div>
                            
                            <div class="stats-row">
                                <div class="stat"><span class="stat-label">Duration</span><span class="stat-val">${dur}</span></div>
                                <div class="stat"><span class="stat-label">Distance</span><span class="stat-val">${dist} km</span></div>
                                <div class="stat"><span class="stat-label">Points</span><span class="stat-val">${pts}</span></div>
                            </div>

                            <div class="btn-group">
                                <button class="btn-json" onclick="downloadJSON(${s.id})">⬇ JSON Data</button>
                                ${renderVideoButtons(s.videoData)}
                            </div>
                        `;
                        list.appendChild(div);
                    });
                };
            };
            
            req.onerror = () => alert("Could not open Database. (Version Mismatch?)");
        }

        function renderVideoButtons(videos) {
            if (!videos || videos.length === 0) return `<div class="video-tag">No Video</div>`;
            return videos.map((v, i) => 
                `<button class="btn-video" onclick="downloadVideo('${v.filename}')">⬇ Video ${i+1}</button>`
            ).join('');
        }

        function downloadJSON(id) {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onsuccess = e => {
                const db = e.target.result;
                db.transaction("sessions", "readonly").objectStore("sessions").get(id).onsuccess = ev => {
                    const data = ev.target.result;
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    const safeDate = new Date(data.id).toISOString().replace(/[:.]/g, '-');
                    a.href = url;
                    a.download = `Run_${safeDate}.json`;
                    a.click();
                };
            };
        }

        function downloadVideo(filename) {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction("videos", "readonly");
                const store = tx.objectStore("videos");
                
                store.get(filename).onsuccess = ev => {
                    const result = ev.target.result; // This is the Blob
                    if (!result) return alert("Video file not found in DB!");
                    
                    const url = URL.createObjectURL(result);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                };
            };
        }

        function deleteSession(id) {
            if(!confirm("Permanently delete this run?")) return;
            
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction(["sessions", "videos"], "readwrite");
                
                // Get session to find associated videos
                tx.objectStore("sessions").get(id).onsuccess = ev => {
                    const data = ev.target.result;
                    if(data && data.videoData) {
                        data.videoData.forEach(v => {
                            tx.objectStore("videos").delete(v.filename);
                        });
                    }
                    tx.objectStore("sessions").delete(id);
                };
                
                tx.oncomplete = () => loadSessions();
            };
        }

        function wipeDatabase() {
            if(!confirm("DANGER: This will delete ALL runs and videos. Are you sure?")) return;
            const req = indexedDB.deleteDatabase(DB_NAME);
            req.onsuccess = () => window.location.reload();
            req.onerror = () => alert("Delete failed. Close other tabs.");
        }

        // --- UTILS ---
        function calcDistance(pts) {
            if (!pts || pts.length < 2) return 0;
            let d = 0;
            for (let i = 1; i < pts.length; i++) {
                d += getDist(pts[i-1], pts[i]);
            }
            return d;
        }

        function getDist(p1, p2) {
            const R = 6371e3;
            const φ1 = p1.lat * Math.PI/180;
            const φ2 = p2.lat * Math.PI/180;
            const Δφ = (p2.lat-p1.lat) * Math.PI/180;
            const Δλ = (p2.lng-p1.lng) * Math.PI/180;
            const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) + Math.cos(φ1)*Math.cos(φ2) * Math.sin(Δλ/2)*Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatDuration(sec) {
            if(!sec) return "0s";
            const m = Math.floor(sec/60);
            const s = Math.floor(sec%60);
            return `${m}m ${s}s`;
        }

        loadSessions();
    </script>
</body>
</html>